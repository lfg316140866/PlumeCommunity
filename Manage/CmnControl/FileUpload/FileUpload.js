CmnMis_UI_Control_FileUpload_Version = "2.2.1", function () { var a = CmnMis.UI.Control; a.FileUpload = function (b, c) { Cmn.Object.Inherit(this, a.BasControl, [b, c]); var d = this, e = null, f = !0; d.Type = "FileUpload", this.IsExistHtmlTemp = !0, this.Val = "", this.DelFilePaths = [], d.SetCfgDescCfg({ SavePath: { Type: "Text", Desc: "上传保存的路径", Val: "/Upload" }, FileSize: { Type: "Text", Desc: "上传文件的大小", Val: "20" }, FileType: { Type: "RadioButton", Desc: "上传控件类型", Val: [{ key: "image", val: "图片上传" }, { key: "file", val: "文件上传" }] }, FileExt: { Type: "TextArea", Desc: "上传文件限制后缀", Val: "jpg,jpeg,png,gif,bmp,mp4,mp3,avi,3gp,rmvb,wmv,mkv,mpg,vob,mov,flv" }, IsSaveRealFileName: { Type: "RadioButton", Desc: "是否保存真实文件名称", Val: [{ key: "0", val: "否" }, { key: "1", val: "是" }] } }), d.ControlCfg = d.InitControlConfig(Cmn.Extend(d.ControlCfg, c)), d.SelectComplete = function () { }, d.OnFilter = function () { }, d.OnComplete = function () { }, d.OnClickDelBtn = function () { }, d.InitControl = function () { Cmn.UI && Cmn.UI.BasPlugin || CmnAjax.Func.LoadJs(Cmn.Func.GetRoot() + "Js/CmnUI/CmnUI.js"), Cmn.UI && Cmn.UI.Upload || CmnAjax.Func.LoadJs(Cmn.Func.GetRoot() + "Js/CmnUI/Upload/Upload.js"), d.Upload = Cmn.UI.Upload(d.ControlDom.find(".cg-Ctl-SelectFileBtn")), d.Upload.LimitFileSuffix = d.ControlCfg.FileExt ? d.ControlCfg.FileExt : d.Upload.LimitFileSuffix, d.Upload.LimitSize = parseInt(d.ControlCfg.FileSize) || 3, d.ControlCfg.SavePath && (d.Upload.SaveRootPath = d.ControlCfg.SavePath), d.Upload.OnFilter.Add(function (a) { a.State ? (e = !1, d.SetValue(a.Path), d.ControlDom.find(".cg-Ctl-ProgressContainer").show(), d.Upload.Upload()) : Cmn.alert(a.Msg) }), d.Upload.OnProgress.Add(function (a) { d.ControlDom.find(".cg-Ctl-Progress").css({ width: a.Progress + "%" }) }), d.Upload.OnComplete.Add(function (a) { a.State ? d.SetValue(a.Path) : (d.SetValue(""), alert("上传失败，" + a.Msg)), e = !0 }), d.ControlDom.find(".cg-Ctl-DelFileItemBtn").click(function () { d.DelFilePaths.push(d.Val), d.SetValue(""), CmnMis.CurUserForm.AfterSave.Add(function () { var c, a = this.DelFilePaths.length, b = ""; if (window["InterfaceUrl"]) for (c = 0; a > c; c++) b = this.DelFilePaths.shift(), CmnAjax.PostData(window["InterfaceUrl"] + "?method=DelFile", { FilePath: b }, function (a) { a["IsSuccess"] && "1" == a.IsSuccess || Cmn.Log("文件删除失败！") }) }, "cmn-Ctl-FileUploadDelFile", d) }) }, d.VerifyInput = function (b, c) { var d = this, f = "", g = Cmn.Func.GetNoHTMLFormatStr(d.GetValue()), h = !0, i = ""; if (0 == e) return c && c.call(d, $.extend(new Cmn.ErrMsg("正在上传中....请稍后保存!"), { control: d })), !1; if ("1" == d.ControlCfg.IsRequired && (f = /\S/, g || (g = ""), f.test($.trim(g)) || (i = d.ControlCfg.ColTitle + " : " + "为必填项！", h = !1)), f = d.ControlCfg.RegexContent, f && h) { if (!Cmn.IsType(f, "string")) return console.error(f.toString() + "正则表达式类型不对！"), !0; "/" == f[0] && (f = f.substr(1, f.length - 2)), f = new RegExp(f), g || (g = ""), f.test($.trim(g)) || (h = !1, i = d.ControlCfg.RegexErrorMsg) } return h ? (d.ControlDom.find(a.Selector.CtlVerifyRight).show(), d.ControlDom.find(a.Selector.CtlVerifyError).hide(), $(b).hide().html(""), !0) : (d.ControlDom.find(a.Selector.CtlVerifyError).show(), d.ControlDom.find(a.Selector.CtlVerifyRight).hide(), d.ControlDom.find(a.Selector.CtlErrTipDesc).html(i), d.ControlDom.find(a.Selector.CtlErrTipDesc).show(), d.ControlDom.find(a.Selector.CtlTipDesc).hide(), $(b).show().html(i), c && c.call(d, $.extend(new Cmn.ErrMsg(i), { control: d })), !1) }, d.GetValue = function () { return d.Val }, d.SetValue = function (a) { a ? (d.ControlDom.find(".cg-Ctl-FileViewContainer").show(), d.ControlDom.find(".cg-Ctl-ProgressContainer").hide(), d.ControlDom.find(".cg-Ctl-Progress").css({ width: "0%" }), d.ControlDom.find(".cg-Ctl-SelectFileBtn").hide(), d.ControlDom.find(".cg-Ctl-FilePreview").html(d.Upload.GetFileName(a)), d.Val = a) : (d.ControlDom.find(".cg-Ctl-SelectFileBtn").show(), d.ControlDom.find(".cg-Ctl-FileViewContainer").hide(), d.ControlDom.find(".cg-Ctl-Progress").css({ width: "0%" }), d.ControlDom.find(".cg-Ctl-FilePreview").empty(), d.Val = "") }, d.Init = function () { d.SetValue("") }, this.SetEnabled = function (b) { f = b, f ? (d.ControlDom.find(a.Selector.CtlContent).find("input").attr("disabled", !1), "" != d.Val && d.ControlDom.find(".cg-Ctl-DelImgItemBtn").show()) : (d.ControlDom.find(a.Selector.CtlContent).find("input").attr("disabled", !0), d.ControlDom.find(".cg-Ctl-DelImgItemBtn").hide()) } } }();